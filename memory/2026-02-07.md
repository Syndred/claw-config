# 2026-02-07 - 每日笔记

## 今日对话摘要

### 会话恢复与 Gateway 系统级配置
- **时间**: 20:06 - 20:23
- **参与**: 主人、旺旺

#### 主要内容
1. **助手上线** - 旺旺响应主人召唤
2. **Gateway 系统级服务化**
   - 将 OpenClaw Gateway 从用户级升级到系统级 systemd 服务
   - 配置开机自启、后台运行、防 OOM 杀进程保护
   - 服务状态: `active` + `enabled`
   - 配置: `Restart=always`, `OOMScoreAdjust=-1000`

3. **对话持久化讨论**
   - 确认服务器重启会中断当前对话（进程层面）
   - 但 Gateway 自启确保重启后能重新建立连接
   - 回顾 AGENTS.md 记忆管理规范:
     - 每日笔记: `memory/YYYY-MM-DD.md`
     - 长期记忆: `MEMORY.md`
     - 需要定期从每日笔记提取精华更新到 MEMORY.md

4. **待办事项确认**
   - 每晚22:00自动执行: 更新配置 → 同步GitHub → 发送每日总结
   - 需要建立每天整理记忆文档的习惯

## 技术操作记录
- 创建系统服务: `/etc/systemd/system/openclaw.service`
- 日志路径: `/var/log/openclaw.log`
- 状态检查: `systemctl status openclaw`

---

## 🔧 故障排查案例：Gateway 崩溃循环

**时间**: 22:03 - 22:28  
**现象**: 关闭 SSH 后旺旺无响应，systemd 服务状态为 `activating` 或 `failed`

### 问题链
1. **历史残留**: 之前前台运行的 Gateway 进程 (pid 13005) 未清理
2. **端口冲突**: 新服务启动时发现 18789 端口被占 → 崩溃
3. **重启风暴**: `Restart=always` 导致5秒内反复重启
4. **系统保护**: 触发 `StartLimitBurst=3`，被 systemd 禁止重启

### 诊断命令
```bash
# 查看服务状态
systemctl status openclaw

# 检查端口占用
lsof -i :18789

# 查看重启计数
journalctl -u openclaw | grep "restart counter"
```

### 解决方案
```bash
# 1. 杀死残留进程
pkill -f "openclaw-gateway"

# 2. 解除重启限制
systemctl reset-failed openclaw

# 3. 启动服务
systemctl start openclaw
```

### 预防措施
- 配置 systemd 服务前，先确保无前台进程运行
- 设置合理的 `RestartSec` (10秒) 和 `StartLimitBurst` (5分钟3次)
- 定期检查 `lsof -i :18789` 确保单进程运行

---

## 下一步
- [x] 检查 cron 任务是否正确配置 GitHub 同步
- [x] 确保每晚的自动总结任务正常运行
- [ ] 定期整理 memory/ 目录下的每日笔记到 MEMORY.md
- [ ] 将本故障案例整理到 MEMORY.md 长期记忆
